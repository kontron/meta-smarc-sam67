From 90b0ba2477c55cbd12c91f7eed5a9d9cd6cd2743 Mon Sep 17 00:00:00 2001
From: Michael Walle <michael.walle@kontron.com>
Date: Fri, 12 Dec 2025 15:05:30 +0100
Subject: [PATCH] update to  6.19

Signed-off-by: Michael Walle <michael.walle@kontron.com>
---
 services/server/env/linux/osfunc.c            |  3 +-
 services/server/env/linux/pmr_os.c            | 20 ++--
 .../server/env/linux/pvr_counting_timeline.c  |  4 +-
 services/server/env/linux/pvr_export_fence.c  | 18 ----
 services/server/env/linux/pvr_fence.c         | 99 -------------------
 services/server/env/linux/pvr_fence_trace.h   | 16 ++-
 services/server/env/linux/pvr_sw_fence.c      | 15 ---
 services/server/env/linux/pvr_sync_file.c     |  7 +-
 services/system/rgx_ti_linux/sysinfo.h        |  1 +
 9 files changed, 20 insertions(+), 163 deletions(-)

diff --git a/services/server/env/linux/osfunc.c b/services/server/env/linux/osfunc.c
index f461523..12bfec5 100644
--- a/services/server/env/linux/osfunc.c
+++ b/services/server/env/linux/osfunc.c
@@ -69,7 +69,6 @@ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #include <linux/utsname.h>
 #include <linux/scatterlist.h>
 #include <linux/interrupt.h>
-#include <linux/pfn_t.h>
 #include <linux/pfn.h>
 #include <linux/sched/clock.h>
 #include <linux/sched/signal.h>
@@ -1436,7 +1435,7 @@ static void OSTimerCallbackBody(TIMER_CALLBACK_DATA *psTimerCBData)
 static void OSTimerCallbackWrapper(struct timer_list *psTimer)
 {
 	TIMER_CALLBACK_DATA *psTimerCBData =
-		from_timer(psTimerCBData, psTimer, sTimer);
+		timer_container_of(psTimerCBData, psTimer, sTimer);
 #else
 /*************************************************************************/ /*!
 @Function       OSTimerCallbackWrapper
diff --git a/services/server/env/linux/pmr_os.c b/services/server/env/linux/pmr_os.c
index f968346..62f902d 100644
--- a/services/server/env/linux/pmr_os.c
+++ b/services/server/env/linux/pmr_os.c
@@ -45,7 +45,6 @@ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #include <linux/mm.h>
 #include <linux/dma-mapping.h>
 #include <linux/version.h>
-#include <linux/pfn_t.h>
 #include <linux/pfn.h>
 
 #include "img_defs.h"
@@ -297,9 +296,9 @@ static INLINE int _OSMMapPMR(PVRSRV_DEVICE_NODE *psDevNode,
 			     IMG_BOOL bUseVMInsertPage, IMG_BOOL bUseMixedMap)
 {
 	IMG_INT32 iStatus;
-	pfn_t sPFN;
+	unsigned long sPFN;
 
-	sPFN = phys_to_pfn_t(psCpuPAddr->uiAddr, 0);
+	sPFN = PHYS_PFN(psCpuPAddr->uiAddr);
 
 	/*
 	 * vm_insert_page() allows insertion of individual pages into user
@@ -329,7 +328,7 @@ static INLINE int _OSMMapPMR(PVRSRV_DEVICE_NODE *psDevNode,
 			/* Since kernel 3.7 this sets VM_MIXEDMAP internally */
 			iStatus = vm_insert_page(ps_vma,
 						 ps_vma->vm_start + uiOffset,
-						 pfn_t_to_page(sPFN));
+						 pfn_to_page(sPFN));
 		}
 	} else {
 		/*
@@ -371,7 +370,7 @@ static INLINE int _OSMMapPMR(PVRSRV_DEVICE_NODE *psDevNode,
 		size_t uiNumContiguousBytes = 1ULL << uiLog2PageSize;
 
 		iStatus = remap_pfn_range(ps_vma, ps_vma->vm_start + uiOffset,
-					  pfn_t_to_pfn(sPFN),
+					  sPFN,
 					  uiNumContiguousBytes,
 					  ps_vma->vm_page_prot);
 	}
@@ -417,7 +416,7 @@ static vm_fault_t MMapPMRFault(struct vm_fault *ps_vmf)
 	PVR_LOG_GOTO_IF_FALSE(bValid, "Attempted remap with invalid PMR offset",
 			      ErrSigFaultReturn);
 
-	ulPFN = pfn_t_to_pfn(phys_to_pfn_t(sCpuPAddr.uiAddr, 0));
+	ulPFN = PHYS_PFN(sCpuPAddr.uiAddr);
 
 	iFault = vmf_insert_pfn_prot(ps_vmf->vma, ps_vmf->address, ulPFN,
 				     ps_vmf->vma->vm_page_prot);
@@ -610,16 +609,15 @@ OSMMapPMRGeneric(PMR *psPMR, PMR_MMAP_DATA pOSMMapData)
 	 * VMA space _only_ if said page is an order-zero allocated page.
 	 */
 	if (bUseVMInsertPage) {
-		pfn_t sPFN;
+		unsigned long sPFN;
 
 		for (uiOffsetIdx = 0; uiOffsetIdx < uiNumOfPFNs;
 		     ++uiOffsetIdx) {
 			if (pbValid[uiOffsetIdx]) {
-				sPFN = phys_to_pfn_t(
-					psCpuPAddr[uiOffsetIdx].uiAddr, 0);
+				sPFN = PHYS_PFN(psCpuPAddr[uiOffsetIdx].uiAddr);
 
-				if (!pfn_t_valid(sPFN) ||
-				    page_count(pfn_t_to_page(sPFN)) == 0) {
+				if (!pfn_valid(sPFN) ||
+				    page_count(pfn_to_page(sPFN)) == 0) {
 					bUseMixedMap = IMG_TRUE;
 					break;
 				}
diff --git a/services/server/env/linux/pvr_counting_timeline.c b/services/server/env/linux/pvr_counting_timeline.c
index 694361c..687559d 100644
--- a/services/server/env/linux/pvr_counting_timeline.c
+++ b/services/server/env/linux/pvr_counting_timeline.c
@@ -115,10 +115,8 @@ static void pvr_counting_fence_timeline_debug_request(
 				  value, timeline->current_value);
 		list_for_each_entry(obj, &timeline->active_fences,
 				    active_list_entry) {
-			obj->fence->ops->fence_value_str(obj->fence, value,
-							 sizeof(value));
 			PVR_DUMPDEBUG_LOG(pfnDumpDebugPrintf, pvDumpDebugFile,
-					  " @%s: val=%llu", value, obj->value);
+					  " @%s: val=%llu", "<unk>", obj->value);
 		}
 		spin_unlock_irqrestore(&timeline->active_fences_lock, flags);
 	}
diff --git a/services/server/env/linux/pvr_export_fence.c b/services/server/env/linux/pvr_export_fence.c
index d31a612..d31d48d 100644
--- a/services/server/env/linux/pvr_export_fence.c
+++ b/services/server/env/linux/pvr_export_fence.c
@@ -270,22 +270,6 @@ static const char *pvr_exp_fence_get_timeline_name(struct dma_fence *fence)
 		return "***NO_TIMELINE***";
 }
 
-static void pvr_exp_fence_value_str(struct dma_fence *fence, char *str,
-				    int size)
-{
-	snprintf(str, size, "%llu", (u64)fence->seqno);
-}
-
-static void pvr_exp_fence_timeline_value_str(struct dma_fence *fence, char *str,
-					     int size)
-{
-	struct pvr_exp_fence *pvr_exp_fence = to_pvr_exp_fence(fence);
-
-	if (pvr_exp_fence && pvr_exp_fence->fence_context)
-		pvr_exp_fence_context_value_str(pvr_exp_fence->fence_context,
-						str, size);
-}
-
 static bool pvr_exp_fence_enable_signaling(struct dma_fence *fence)
 {
 	struct pvr_exp_fence *exp_fence = to_pvr_exp_fence(fence);
@@ -369,8 +353,6 @@ static void pvr_exp_fence_release(struct dma_fence *fence)
 static const struct dma_fence_ops pvr_exp_fence_ops = {
 	.get_driver_name = pvr_exp_fence_get_driver_name,
 	.get_timeline_name = pvr_exp_fence_get_timeline_name,
-	.fence_value_str = pvr_exp_fence_value_str,
-	.timeline_value_str = pvr_exp_fence_timeline_value_str,
 	.enable_signaling = pvr_exp_fence_enable_signaling,
 	.wait = dma_fence_default_wait,
 	.release = pvr_exp_fence_release,
diff --git a/services/server/env/linux/pvr_fence.c b/services/server/env/linux/pvr_fence.c
index 563f4c2..1e17829 100644
--- a/services/server/env/linux/pvr_fence.c
+++ b/services/server/env/linux/pvr_fence.c
@@ -128,8 +128,6 @@ pvr_fence_context_fences_dump(struct pvr_fence_context *fctx,
 		const char *timeline_value_str = "unknown timeline value";
 		const char *fence_value_str = "unknown fence value";
 
-		pvr_fence->base.ops->fence_value_str(&pvr_fence->base, value,
-						     sizeof(value));
 		PVR_DUMPDEBUG_LOG(pfnDumpDebugPrintf, pvDumpDebugFile, " @%s",
 				  value);
 
@@ -185,24 +183,12 @@ pvr_fence_context_fences_dump(struct pvr_fence_context *fctx,
 			continue;
 		}
 
-		if (fence->ops->timeline_value_str) {
-			fence->ops->timeline_value_str(fence, value,
-						       sizeof(value));
-			timeline_value_str = value;
-		}
-
 		PVR_DUMPDEBUG_LOG(pfnDumpDebugPrintf, pvDumpDebugFile,
 				  " | %s: %s (driver: %s)",
 				  fence->ops->get_timeline_name(fence),
 				  timeline_value_str,
 				  fence->ops->get_driver_name(fence));
 
-		if (fence->ops->fence_value_str) {
-			fence->ops->fence_value_str(fence, value,
-						    sizeof(value));
-			fence_value_str = value;
-		}
-
 		PVR_DUMPDEBUG_LOG(pfnDumpDebugPrintf, pvDumpDebugFile,
 				  " |  @%s (foreign)", fence_value_str);
 	}
@@ -604,44 +590,6 @@ static const char *pvr_fence_get_timeline_name(struct dma_fence *fence)
 	return NULL;
 }
 
-static void pvr_fence_fence_value_str(struct dma_fence *fence, char *str,
-				      int size)
-{
-	struct pvr_fence *pvr_fence = to_pvr_fence(fence);
-
-	if (!pvr_fence)
-		return;
-
-	snprintf(
-		str, size,
-		"%llu: (%s%s) refs=%u fwaddr=%#08x enqueue=%u status=%-9s %s%s",
-		(u64)pvr_fence->fence->seqno,
-		test_bit(DMA_FENCE_FLAG_ENABLE_SIGNAL_BIT,
-			 &pvr_fence->fence->flags) ?
-			"+" :
-			"-",
-		test_bit(DMA_FENCE_FLAG_SIGNALED_BIT,
-			 &pvr_fence->fence->flags) ?
-			"+" :
-			"-",
-		refcount_read(&pvr_fence->fence->refcount.refcount),
-		PVRSRV_UFO_GET_FWADDR(SyncCheckpointGetFirmwareAddr(
-			pvr_fence->sync_checkpoint)),
-		SyncCheckpointGetEnqueuedCount(pvr_fence->sync_checkpoint),
-		SyncCheckpointGetStateString(pvr_fence->sync_checkpoint),
-		pvr_fence->name,
-		(&pvr_fence->base != pvr_fence->fence) ? "(foreign)" : "");
-}
-
-static void pvr_fence_timeline_value_str(struct dma_fence *fence, char *str,
-					 int size)
-{
-	struct pvr_fence *pvr_fence = to_pvr_fence(fence);
-
-	if (pvr_fence)
-		pvr_context_value_str(pvr_fence->fctx, str, size);
-}
-
 static bool pvr_fence_enable_signaling(struct dma_fence *fence)
 {
 	struct pvr_fence *pvr_fence = to_pvr_fence(fence);
@@ -702,8 +650,6 @@ static void pvr_fence_release(struct dma_fence *fence)
 static const struct dma_fence_ops pvr_fence_ops = {
 	.get_driver_name = pvr_fence_get_driver_name,
 	.get_timeline_name = pvr_fence_get_timeline_name,
-	.fence_value_str = pvr_fence_fence_value_str,
-	.timeline_value_str = pvr_fence_timeline_value_str,
 	.enable_signaling = pvr_fence_enable_signaling,
 	.signaled = pvr_fence_is_signaled,
 	.wait = dma_fence_default_wait,
@@ -797,49 +743,6 @@ static const char *pvr_fence_foreign_get_timeline_name(struct dma_fence *fence)
 	return "foreign";
 }
 
-static void pvr_fence_foreign_fence_value_str(struct dma_fence *fence,
-					      char *str, int size)
-{
-	struct pvr_fence *pvr_fence = to_pvr_fence(fence);
-	u32 sync_addr = 0;
-	u32 sync_value_next;
-
-	if (WARN_ON(!pvr_fence))
-		return;
-
-	sync_addr = SyncCheckpointGetFirmwareAddr(pvr_fence->sync_checkpoint);
-	sync_value_next = PVRSRV_SYNC_CHECKPOINT_SIGNALLED;
-
-	/*
-	 * Include the fence flag bits from the foreign fence instead of our
-	 * shadow copy. This is done as the shadow fence flag bits aren't used.
-	 */
-	snprintf(str, size,
-		 "%llu: (%s%s) refs=%u fwaddr=%#08x cur=%#08x nxt=%#08x %s",
-		 (u64)fence->seqno,
-		 test_bit(DMA_FENCE_FLAG_ENABLE_SIGNAL_BIT,
-			  &pvr_fence->fence->flags) ?
-			 "+" :
-			 "-",
-		 test_bit(DMA_FENCE_FLAG_SIGNALED_BIT,
-			  &pvr_fence->fence->flags) ?
-			 "+" :
-			 "-",
-		 refcount_read(&fence->refcount.refcount),
-		 PVRSRV_UFO_GET_FWADDR(sync_addr),
-		 pvr_fence_sync_value(pvr_fence), sync_value_next,
-		 pvr_fence->name);
-}
-
-static void pvr_fence_foreign_timeline_value_str(struct dma_fence *fence,
-						 char *str, int size)
-{
-	struct pvr_fence *pvr_fence = to_pvr_fence(fence);
-
-	if (pvr_fence)
-		pvr_context_value_str(pvr_fence->fctx, str, size);
-}
-
 static bool pvr_fence_foreign_enable_signaling(struct dma_fence *fence)
 {
 	WARN_ON("cannot enable signalling on foreign fence");
@@ -881,8 +784,6 @@ static void pvr_fence_foreign_release(struct dma_fence *fence)
 static const struct dma_fence_ops pvr_fence_foreign_ops = {
 	.get_driver_name = pvr_fence_foreign_get_driver_name,
 	.get_timeline_name = pvr_fence_foreign_get_timeline_name,
-	.fence_value_str = pvr_fence_foreign_fence_value_str,
-	.timeline_value_str = pvr_fence_foreign_timeline_value_str,
 	.enable_signaling = pvr_fence_foreign_enable_signaling,
 	.wait = pvr_fence_foreign_wait,
 	.release = pvr_fence_foreign_release,
diff --git a/services/server/env/linux/pvr_fence_trace.h b/services/server/env/linux/pvr_fence_trace.h
index 9fba2bd..f1e20bf 100644
--- a/services/server/env/linux/pvr_fence_trace.h
+++ b/services/server/env/linux/pvr_fence_trace.h
@@ -95,8 +95,8 @@ DECLARE_EVENT_CLASS(
 			       fence->base.ops->get_driver_name(&fence->base));
 		pvr_assign_str(timeline,
 			       fence->base.ops->get_timeline_name(&fence->base));
-		fence->base.ops->fence_value_str(&fence->base, __entry->val,
-						 sizeof(__entry->val));
+		(void)OSStringSafeCopy(__entry->val, "unknown",
+				       sizeof(__entry->val));
 		__entry->context = fence->base.context;),
 
 	TP_printk("driver=%s timeline=%s ctx=%llu val=%s", __get_str(driver),
@@ -141,8 +141,8 @@ DECLARE_EVENT_CLASS(
 			       fence->base.ops->get_driver_name(&fence->base));
 		pvr_assign_str(timeline,
 			       fence->base.ops->get_timeline_name(&fence->base));
-		fence->base.ops->fence_value_str(&fence->base, __entry->val,
-						 sizeof(__entry->val));
+		(void)OSStringSafeCopy(__entry->val, "unknown",
+				       sizeof(__entry->val));
 		__entry->context = fence->base.context;
 		pvr_assign_str(foreign_driver,
 			       fence->fence->ops->get_driver_name ?
@@ -154,12 +154,8 @@ DECLARE_EVENT_CLASS(
 				       fence->fence->ops->get_timeline_name(
 					       fence->fence) :
 				       "unknown");
-		fence->fence->ops->fence_value_str ?
-			fence->fence->ops->fence_value_str(
-				fence->fence, __entry->foreign_val,
-				sizeof(__entry->foreign_val)) :
-			(void)OSStringSafeCopy(__entry->foreign_val, "unknown",
-					       sizeof(__entry->foreign_val));
+		(void)OSStringSafeCopy(__entry->foreign_val, "unknown",
+				       sizeof(__entry->foreign_val));
 		__entry->foreign_context = fence->fence->context;),
 
 	TP_printk(
diff --git a/services/server/env/linux/pvr_sw_fence.c b/services/server/env/linux/pvr_sw_fence.c
index cb6fab1..801149c 100644
--- a/services/server/env/linux/pvr_sw_fence.c
+++ b/services/server/env/linux/pvr_sw_fence.c
@@ -98,19 +98,6 @@ static const char *pvr_sw_fence_get_timeline_name(struct dma_fence *fence)
 	return pvr_sw_fence_context_name(pvr_sw_fence->fence_context);
 }
 
-static void pvr_sw_fence_value_str(struct dma_fence *fence, char *str, int size)
-{
-	snprintf(str, size, "%llu", (u64)fence->seqno);
-}
-
-static void pvr_sw_fence_timeline_value_str(struct dma_fence *fence, char *str,
-					    int size)
-{
-	struct pvr_sw_fence *pvr_sw_fence = to_pvr_sw_fence(fence);
-
-	pvr_sw_fence_context_value_str(pvr_sw_fence->fence_context, str, size);
-}
-
 static bool pvr_sw_fence_enable_signaling(struct dma_fence *fence)
 {
 	return true;
@@ -143,8 +130,6 @@ static void pvr_sw_fence_release(struct dma_fence *fence)
 static const struct dma_fence_ops pvr_sw_fence_ops = {
 	.get_driver_name = pvr_sw_fence_get_driver_name,
 	.get_timeline_name = pvr_sw_fence_get_timeline_name,
-	.fence_value_str = pvr_sw_fence_value_str,
-	.timeline_value_str = pvr_sw_fence_timeline_value_str,
 	.enable_signaling = pvr_sw_fence_enable_signaling,
 	.wait = dma_fence_default_wait,
 	.release = pvr_sw_fence_release,
diff --git a/services/server/env/linux/pvr_sync_file.c b/services/server/env/linux/pvr_sync_file.c
index 29e6856..ccc264f 100644
--- a/services/server/env/linux/pvr_sync_file.c
+++ b/services/server/env/linux/pvr_sync_file.c
@@ -1288,14 +1288,11 @@ static void _dump_sync_point(struct dma_fence *fence,
 {
 	const struct dma_fence_ops *fence_ops = fence->ops;
 	bool signaled = dma_fence_is_signaled(fence);
-	char time[16] = { '\0' };
-
-	fence_ops->timeline_value_str(fence, time, sizeof(time));
 
 	PVR_DUMPDEBUG_LOG(dump_debug_printf, dump_debug_file,
 			  "<" IMG_KM_PTR_FMTSPEC
-			  "> Seq#=%llu TS=%s State=%s TLN=%s",
-			  fence, (u64)fence->seqno, time,
+			  "> Seq#=%llu TS=%d State=%s TLN=%s",
+			  fence, (u64)fence->seqno, 0,
 			  (signaled) ? "Signalled" : "Active",
 			  fence_ops->get_timeline_name(fence));
 }
diff --git a/services/system/rgx_ti_linux/sysinfo.h b/services/system/rgx_ti_linux/sysinfo.h
index 4193755..21e83e7 100644
--- a/services/system/rgx_ti_linux/sysinfo.h
+++ b/services/system/rgx_ti_linux/sysinfo.h
@@ -57,6 +57,7 @@ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #define SYS_RGX_OF_COMPATIBLE    \
 	_COMPAT("ti,j721e-pvr")  \
 	_COMPAT("ti,am62-gpu")   \
+	_COMPAT("ti,am62p-gpu")   \
 	_COMPAT("ti,j721s2-gpu") \
 	_COMPAT("ti,j721s2-pvr") \
 	_COMPAT("ti,am62p-pvr")
-- 
2.47.3

